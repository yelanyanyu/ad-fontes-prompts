<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <title>Etymos Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Lora:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        serif: ['Noto Serif SC', 'serif'],
                    },
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        bg: '#f8fafc',
                        surface: '#ffffff',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex overflow-hidden bg-slate-50 text-slate-800">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-slate-300 flex flex-col transition-all duration-300 flex-none h-full z-20">
        <!-- Sidebar Toggle -->
        <div class="p-4 flex items-center justify-center h-16 border-b border-slate-800">
            <button onclick="toggleSidebar()" class="text-slate-500 hover:text-white transition-colors p-1">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
        
        <!-- Navigation -->
        <nav class="flex-1 px-3 py-6 space-y-1 overflow-y-auto">
            <a href="/words" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 transition-colors group">
                <i class="fa-solid fa-book w-5 text-center transition-colors group-hover:text-white"></i>
                <span class="sidebar-text font-medium whitespace-nowrap">Words</span>
            </a>
            <a href="/phrase" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 transition-colors group">
                <i class="fa-solid fa-quote-left w-5 text-center transition-colors group-hover:text-white"></i>
                <span class="sidebar-text font-medium whitespace-nowrap">Phrases</span>
            </a>
        </nav>

        <!-- Footer / Settings -->
        <div class="p-4 border-t border-slate-800">
            <button onclick="openSettings()" class="sidebar-item flex items-center gap-3 px-3 py-2.5 w-full rounded-lg hover:bg-slate-800 transition-colors text-left group">
                <div class="relative flex-none">
                    <i class="fa-solid fa-gear w-5 text-center group-hover:text-white transition-colors"></i>
                    <span id="connStatusDot" class="absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full bg-red-500 border-2 border-slate-900"></span>
                </div>
                <span class="sidebar-text font-medium whitespace-nowrap">Settings</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col min-w-0 h-full relative">
        
        <!-- Top Bar -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 flex-none z-10">
            <!-- Logo & Title -->
            <div class="flex items-center gap-3">
                <img src="logo.svg" alt="Logo" class="w-8 h-8 rounded-lg flex-none bg-slate-100">
                <h1 class="font-bold text-slate-800 tracking-tight text-lg">Etymos</h1>
            </div>
            
            <!-- Actions -->
            <div class="flex items-center gap-4 ml-4">
                <!-- Add New Button Placeholder -->
            </div>
        </header>

        <!-- View Container -->
        <div class="flex-1 relative overflow-hidden">
            
            <!-- 1. Split View (Default) -->
            <main id="mainContainer" class="absolute inset-0 flex flex-row p-4 gap-0 h-full">
                <!-- Left: Editor -->
                <div id="leftPanel" class="flex flex-col h-full min-w-[300px]" style="width: 45%;">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col min-h-0 overflow-hidden relative">
                        <!-- Editor Header -->
                        <div class="flex justify-between items-center px-4 py-3 border-b border-slate-100 bg-slate-50/50 flex-none">
                            <div class="flex items-center gap-3">
                                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider">YAML Editor</h2>
                                <span id="yamlStatus"></span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="togglePreview()" class="text-xs text-slate-500 hover:text-primary px-2 py-1 rounded hover:bg-slate-100 flex items-center gap-1 transition-colors">
                                    <i class="fa-regular fa-eye"></i> Preview
                                </button>
                                <button onclick="clearInput()" class="text-xs text-slate-400 hover:text-red-500 px-2 py-1 rounded hover:bg-red-50 transition-colors">
                                    Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Editor Body -->
                        <div class="flex-1 relative group min-h-0">
                            <!-- Textarea -->
                            <div id="editorView" class="absolute inset-0 flex flex-col">
                                <textarea id="yamlInput" class="flex-1 w-full h-full font-mono text-sm bg-white p-4 resize-none outline-none focus:bg-slate-50 transition-colors" placeholder="Paste your YAML here..." spellcheck="false"></textarea>
                            </div>
                            <!-- Simple Preview Overlay -->
                            <div id="previewView" class="hidden absolute inset-0 flex-col bg-white z-10">
                                <div id="previewContent" class="flex-1 overflow-y-auto p-4 bg-slate-50"></div>
                            </div>
                        </div>

                        <!-- Editor Footer -->
                        <div class="p-3 border-t border-slate-100 bg-white flex justify-end flex-none">
                            <button onclick="saveData()" id="saveBtn" class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm flex items-center gap-2">
                                <i class="fa-regular fa-floppy-disk"></i>
                                <span id="saveBtnText">Save</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resizer -->
                <div id="dragHandle" class="resizer z-20"></div>

                <!-- Right: List -->
                <div id="rightPanel" class="flex-1 flex flex-col h-full min-w-[350px] min-h-0">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-col flex h-full overflow-hidden ml-1">
                        <!-- List Toolbar -->
                        <div class="px-4 py-3 border-b border-slate-100 flex flex-col gap-3 bg-slate-50/50 flex-none">
                            <!-- Search Row -->
                            <div class="relative w-full">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs"></i>
                                <input type="text" id="searchInput" placeholder="Search..." 
                                    class="w-full bg-white border border-slate-200 rounded-lg py-1.5 pl-8 pr-4 text-xs focus:ring-1 focus:ring-primary transition-all outline-none placeholder-slate-400"
                                    oninput="filterAndSortRecords()">
                            </div>

                            <!-- Controls Row -->
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <select id="sortSelect" onchange="filterAndSortRecords()" class="text-xs border border-slate-200 rounded px-2 py-1.5 bg-white text-slate-600 outline-none focus:ring-1 focus:ring-primary shadow-sm cursor-pointer">
                                        <option value="az">A-Z</option>
                                        <option value="za">Z-A</option>
                                        <option value="newest">Newest</option>
                                        <option value="oldest">Oldest</option>
                                    </select>
                                    <div class="flex items-center gap-2 bg-white border border-slate-200 rounded px-2 py-1 shadow-sm">
                                        <span class="text-[10px] text-slate-400 uppercase font-bold">Size</span>
                                        <input type="number" id="pageSizeInput" value="20" min="1" max="500" class="w-10 text-xs bg-transparent outline-none text-center font-medium text-slate-700" onchange="updatePageSize()">
                                    </div>
                                    <button onclick="resetListPrefs()" id="resetListPrefsBtn" class="text-xs border border-slate-200 bg-white text-slate-600 px-2.5 py-1.5 rounded-lg hover:bg-slate-50 transition-colors flex items-center gap-1 font-bold" title="Reset list preferences">
                                        <i class="fa-solid fa-rotate-left"></i>
                                        Reset
                                    </button>
                                    <button onclick="syncAll()" id="syncAllBtn" class="hidden text-xs bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded-full hover:bg-yellow-200 transition-colors flex items-center gap-1 font-medium">
                                        <i class="fa-solid fa-rotate"></i> Sync All
                                    </button>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span id="totalCountBadge" class="hidden text-xs font-bold text-slate-500 bg-slate-100 border border-slate-200 px-2 py-0.5 rounded-full"></span>
                                    <button onclick="refreshRecords()" class="text-slate-400 hover:text-primary transition-colors p-1" title="Reload All">
                                        <i class="fa-solid fa-arrows-rotate"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- List Content -->
                        <div id="recordsList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                            <div class="text-center text-slate-400 py-10 flex flex-col items-center gap-2">
                                <i class="fa-solid fa-spinner fa-spin text-2xl"></i>
                                <span>Loading records...</span>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="p-3 border-t border-slate-100 bg-white flex justify-between items-center text-xs text-slate-500 flex-none">
                            <span id="pageInfo" class="font-medium">Page 1 of 1</span>
                            <div class="flex items-center gap-2">
                                <button onclick="changePage(-1)" id="prevPageBtn" class="px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">Prev</button>
                                <div id="pageNumbers" class="flex items-center gap-1"></div>
                                <button onclick="changePage(1)" id="nextPageBtn" class="px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 2. Preview View (Full Screen Overlay) -->
            <div id="previewContainer" class="hidden absolute inset-0 bg-slate-100 overflow-y-auto flex flex-col z-30">
                <!-- Preview Header -->
                <div class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-3 flex items-center justify-between shadow-sm">
                     <button onclick="closePreviewPage()" class="text-slate-500 hover:text-slate-800 flex items-center gap-2 font-bold text-sm transition-colors group">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center group-hover:bg-slate-200 transition-colors">
                            <i class="fa-solid fa-arrow-left"></i>
                        </div>
                        <span>Back to List</span>
                     </button>
                     
                     <!-- View Toggle -->
                     <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button id="previewToggleCardBtn" onclick="togglePreviewStyle('card')" class="px-4 py-1.5 text-xs rounded-md shadow-sm bg-white text-slate-700 font-bold transition-colors hover:bg-gray-50">Card</button>
                        <button id="previewToggleMarkdownBtn" onclick="togglePreviewStyle('markdown')" class="px-4 py-1.5 text-xs rounded-md text-slate-500 hover:text-slate-700 font-medium transition-colors hover:bg-slate-200/50">Markdown</button>
                     </div>
                </div>
                
                <div id="previewContentWrapper" class="p-8 w-full max-w-5xl mx-auto flex-1">
                    <!-- Dynamic Content -->
                </div>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden m-6">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">Settings</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Database Connection String</label>
                    <input type="password" id="modalDbUrl" class="w-full text-sm p-2 rounded border border-slate-200 focus:ring-2 focus:ring-primary outline-none font-mono" placeholder="postgresql://user:pass@localhost:5432/db">
                    <p class="text-xs text-slate-400 mt-1">Leave empty to use environment variables.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Max Local Items (Offline Cache)</label>
                    <input type="number" id="modalMaxItems" class="w-full text-sm p-2 rounded border border-slate-200 focus:ring-2 focus:ring-primary outline-none" placeholder="100">
                    <p class="text-xs text-slate-400 mt-1">Oldest items will be removed when limit is reached.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Word Card Template</label>
                    <select id="modalWordCardTemplateMode" class="w-full text-sm p-2 rounded border border-slate-200 focus:ring-2 focus:ring-primary outline-none bg-white">
                        <option value="default">Default (Current Card)</option>
                        <option value="custom">Custom Template</option>
                    </select>
                    <p class="text-xs text-slate-400 mt-1">Custom template applies to Preview â†’ Card mode (Words only).</p>
                </div>
                <div id="modalWordCardTemplateEditor" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Custom Template (HTML)</label>
                    <textarea id="modalWordCardTemplate" rows="10" class="w-full text-xs p-3 rounded border border-slate-200 focus:ring-2 focus:ring-primary outline-none font-mono" placeholder="Use {{yield.lemma}} etc. Use {{#each application.selected_examples}}...{{/each}} for lists."></textarea>
                    <div class="mt-2 flex justify-end">
                        <button type="button" id="resetWordCardTemplateBtn" class="text-xs px-3 py-1.5 rounded border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors">Reset to Default</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <span id="testStatus" class="text-slate-500">Status: Unknown</span>
                    <button onclick="testConnection()" class="text-primary hover:underline text-xs">Test Connection</button>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 text-sm hover:bg-white transition-colors">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 rounded-lg bg-primary text-white text-sm hover:bg-blue-600 transition-colors shadow-sm">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Conflict Modal -->
    <div id="conflictModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[80vh] flex flex-col overflow-hidden m-6">
            <!-- Modal Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 flex-none">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Conflict Detected</h3>
                    <p class="text-sm text-slate-500">The word exists but content differs. Choose an action.</p>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <!-- Diff Summary -->
            <div class="px-6 py-3 bg-yellow-50 border-b border-yellow-100 flex-none">
                <h4 class="text-xs font-bold text-yellow-700 uppercase tracking-wider mb-2">Changed Fields</h4>
                <div id="diffSummary" class="flex flex-wrap gap-2 text-xs font-mono">
                    <!-- Badges injected here -->
                </div>
            </div>
            
            <!-- Diff Area -->
            <div class="flex-1 grid grid-cols-2 divide-x divide-slate-200 overflow-hidden min-h-0">
                <!-- Old Data -->
                <div class="flex flex-col bg-slate-50/30 h-full min-h-0 overflow-hidden">
                    <div class="p-3 bg-slate-100 text-xs font-bold text-slate-600 uppercase tracking-wider text-center border-b flex-none">
                        Current Database (v<span id="oldVer"></span>)
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 font-mono text-xs whitespace-pre-wrap h-full" id="diffOld"></div>
                </div>
                
                <!-- New Data -->
                <div class="flex flex-col bg-white h-full min-h-0 overflow-hidden">
                    <div class="p-3 bg-blue-50 text-xs font-bold text-blue-600 uppercase tracking-wider text-center border-b flex-none">
                        New Input
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 font-mono text-xs whitespace-pre-wrap h-full" id="diffNew"></div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-slate-100 bg-white flex justify-end gap-4 flex-none">
                <button onclick="resolveConflict(false)" class="px-6 py-2 rounded-lg border border-slate-300 text-slate-700 font-medium hover:bg-slate-50 transition-colors">
                    Use Existing (Log Only)
                </button>
                <button onclick="resolveConflict(true)" class="px-6 py-2 rounded-lg bg-red-500 text-white font-medium hover:bg-red-600 transition-colors shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    Overwrite & Update
                </button>
            </div>
        </div>
    </div>

    <!-- Batch Conflict Modal -->
    <div id="batchConflictModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col m-4">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="text-orange-500"><i class="fa-solid fa-triangle-exclamation"></i></span> Batch Sync Conflicts
                    </h3>
                    <p class="text-sm text-slate-500 mt-1" id="batchSummaryText">Found X conflicts among Y items</p>
                </div>
                <button onclick="closeBatchModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                <div class="flex gap-4 mb-4">
                    <button onclick="batchSetAction('overwrite')" class="px-3 py-1.5 text-xs font-medium bg-red-100 text-red-700 rounded hover:bg-red-200">Set All to Overwrite</button>
                    <button onclick="batchSetAction('skip')" class="px-3 py-1.5 text-xs font-medium bg-slate-200 text-slate-700 rounded hover:bg-slate-300">Set All to Skip</button>
                </div>

                <div id="batchList" class="space-y-3">
                    <!-- Dynamic Items -->
                </div>
            </div>

            <div class="p-6 border-t bg-white rounded-b-xl flex justify-end gap-3">
                <button onclick="closeBatchModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors">Cancel</button>
                <button onclick="executeBatchSync()" class="px-6 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg font-medium shadow-sm transition-colors">Confirm & Sync</button>
            </div>
        </div>
    </div>

    <div id="toastRoot" class="fixed top-4 right-4 z-[60] flex flex-col gap-2 pointer-events-none" aria-live="polite" aria-relevant="additions"></div>

    <!-- JS Deps -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module" src="js/main.js"></script>
</body>
</html>
